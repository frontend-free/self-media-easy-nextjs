// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Platform {
  // 抖音
  TIKTOK
  // 视频号
  WEIXIN_VIDEO
}

enum AccountStatus {
  // 未授权
  UNAUTHED
  // 已授权
  AUTHED
  // 已失效
  INVALID
}

enum PublishResourceType {
  // 视频
  VIDEO
}

enum PublishType {
  // 正式
  OFFICIAL
  // 草稿
  DRAFT
}

enum TaskStatus {
  // 等待发布
  PENDING
  // 发布中
  PUBLISHING
  // 发布成功
  SUCCESS
  // 发布失败
  FAILED
  // 已取消
  CANCELLED
}

enum H5AuthStatus {
  // 等待处理
  PENDING
  // 扫码中
  QRCODE
  // 等待输入验证码
  MOBILE_CODE
  // 成功
  SUCCESS
  // 失败
  FAILED
}

// 用户模型
model User {
  id       String  @id @default(uuid())
  name     String  @unique
  password String
  avatar   String?
  mobile   String?
  nickname String?
  schoolId String?
  isAdmin  Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  tagCoachList       TagCoach[]
  Account            Account[]
  publishes          Publish[]
  tasks              Task[]
  autoPublishSetting AutoPublishSetting[]
  setting            Setting[]
  h5Auths            H5Auth[]
  schools            School[]
}

// 标签-教练
model TagCoach {
  id   String @id @default(uuid())
  name String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userId  String
  user    User      @relation(fields: [userId], references: [id])
  account Account[]
}

// 账号
model Account {
  id             String         @id @default(uuid())
  platform       Platform // 平台
  platformName   String? // 平台名称
  platformAvatar String? // 平台头像
  platformId     String? // 平台ID
  authInfo       String? // 授权信息
  status         AccountStatus? @default(UNAUTHED) // 账号状态
  authedAt       DateTime // 授权时间
  logs           String? // 授权日志 JSON

  studentId String? // 学员ID

  tagCoachId String?
  tagCoach   TagCoach? @relation(fields: [tagCoachId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userId    String
  user      User      @relation(fields: [userId], references: [id])
  tasks     Task[]
  publishes Publish[]
}

// H5 授权
model H5Auth {
  id String @id @default(uuid())
  platform       Platform // 平台
  schoolId       String // 驾校ID
  studentId      String // 学员ID
  status H5AuthStatus @default(PENDING) // 状态
  qrcode String? // 二维码
  mobileCode String? // 手机验证码

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userId    String
  user      User      @relation(fields: [userId], references: [id])
}

// 发布
model Publish {
  id              String              @id @default(uuid())
  resourceType    PublishResourceType // 资源类型
  resourceOfVideo String? // 视频资源
  title           String? // 标题
  description     String? // 描述
  adText          String? // 广告文案 \n 换行
  publishType     PublishType // 发布类型

  accounts Account[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id])
  tasks  Task[] // 任务
}

// 任务
model Task {
  id      String     @id @default(uuid())
  status  TaskStatus @default(PENDING) // 任务状态
  remark  String? // 任务备注
  logs    String? // 任务日志 JSON
  startAt DateTime? // 开始发布时间
  endAt   DateTime? // 结束发布时间

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  publishId String
  publish   Publish @relation(fields: [publishId], references: [id])
}

// 自动发布设置
model AutoPublishSetting {
  id String @id // 使用 userId 作为主键

  resourceVideoDir    String? // 视频资源目录
  title               String? // 标题
  autoTitle           Boolean?  @default(false) // 是否自动生成标题
  publishCount        Int? @default(2) // 每个账号发布数量
  autoAdText          Boolean?  @default(true) // 是否自动生成广告文案

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [id], references: [id])
}

model School {
  id String @id
  name String?
  address String?
  phone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  userId String
  user User @relation(fields: [userId], references: [id])
}

model Setting {
  id String @id // 使用 userId 作为主键

  recorderOutputDir String? // 录制输出目录
  recorderList      String? // 录制列表 JSON {roomId: string, description: string, auto: boolean, title?: string}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [id], references: [id])
}